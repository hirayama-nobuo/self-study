# ファイルアクセス制御(第9章)

## グループ  
UNIXシステムでは複数のユーザーをグループという単位で管理する。  
1人のユーザーが複数のグループに属することが可能。  
ユーザーを作成するとデフォルトで同名のグループが作成される。  
ユーザーは最低でも一つのグループに属し、rootユーザーの設定により複数のグループに属することも可能。  
グループ機能を使用することにより、ファイルの読み、書き、実行をまとめて許可することができる。  

## パーミッション(アクセス権)  
データファイルを作成した場合、作成者がファイルのオーナーとなる。  
ファイルの読み出し、書き込み、実行の可能不可能を決定するファイル属性をパーミッションという。  
パーミションの設定はrwxで表現する。  
パーミッションの構成  
- オーナー  
  r:読み出し
  w:書き込み  
  x:実行  
- グループ
  r:読み出し
  w:書き込み  
  x:実行  
- その他  
  r:読み出し
  w:書き込み  
  x:実行  
オーナーがread/writeが可能、グループがread可能、その他は不可の設定にする場合、「rw-r-----」で表現する。  
パーミッションは8進数で表現する場合がある。  
可能を1、不可を0で表すと、「rw-r--r--」の場合、8進数「110 100 100」となり、644で表す。  
パーミッションはchmodコマンドを使用し、変更する。  

パーミッションの設定にはマスク値が関連する。  
マスク値はファイル新規作成時に設定したくないパーミッションの位置情報を指定する目的がある。  
スーパーユーザーの標準的なパーミッションは「644」、一般ユーザーの標準的なパーミッションは「664」  
マスク値の変更はumaskコマンドで変更する。  
自分自身にあらゆる許可をあたえないマスク値「077」に設定すると、パーミションは「-rw------」となる。  

ファイル(ディレクトリ)のパーミッションを変更する場合、chmodコマンドを使用する。  
指定は8進数での表記で行う。  

パーミションを設定した場合、以下の機能になる。  
- ファイル  

|  記号  |  説明  |
| ---- | ---- |
|  r  |  読み込み可能  |
|  w  |  書き込み可能  |
|  x |  実行可能  |  

- ディレクトリ  

|  記号  |  説明  |
| ---- | ---- |
|  r  |  ディレクトリリストを表示可能  |
|  w  |  ディレクトリ内のファイルを削除したり、サブディレクトリを作成可能  |
|  x |  cdコマンドが使用できる、内部の確認ができる  |

## オーナー変更  
ファイルのオーナー変更にはchownコマンドを使用する。  
スーパーユーザーのみが使用可能なコマンド。  
あるディレクトリ以下の全てのファイルを一括で変更する場合、-Rオプションを使用する。  

# マニュアル表示とコマンド調査(第10章)

## コマンドマニュアル  
コマンドや環境設定ファイルなどの用法がわからない場合、UNIXのオンラインマニュアルを確認する。  
manコマンドを使用することで指定キーワードをマニュアルから探し、最初に見つかった情報を表示する。  
同じ項目が複数の章で出る場合、以下のようにその位置を指定する。  
```
mount(2) 2章にあるmountの説明  
```

単にコマンドの用法を知りたいだけの場合は、各コマンドのヘルプ表示にすることで簡単にみることができる。  
```
調べるコマンド名 --help
```
マニュアルには日本語版と英語版が存在する。  
現在ではmanコマンドを実行すると日本語版マニュアルが表示される設定となっている。  
どちらをデフォルトで表示させるかは環境変数LANGによって切り替えることができる。  
また、最新情報は英語版から反映される。  

manコマンドによるマニュアルテキストは長文になることが多いため、指定したページ名の説明文の先頭行だけを表示する機能が存在する。  
```
man -f ページ名
whatis ページ名  
```
明確なコマンド名がわからない場合でも、manコマンドの-kオプションでコマンド名の一部での検索が可能。  
```
man -k pass
```

## indexデータベース  
whatisコマンドやapproposコマンドの実行で、オンラインマニュアルの見出し部分をすべて検索する。  
膨大なオンラインマニュアルをすべて検索するのは効率的でない。  
効率化するために、見出し部分をあらかじめ抜き出し、indexデータベースを作成する。  
mandbコマンドを使用してindexデータベースを作成・更新する。  
マニュアルに追加があった場合、mandbコマンドを実行する。  

## コマンドについて  
whatisコマンドに対応してwhereisコマンドが存在する。  
指定したコマンドのファイルの格納場所を確認可能。  
コマンドのパスはtypeコマンドでも確認が可能。  
```
type -path sort sortコマンドのパスを確認
```
typeコマンドを用いることで、対象のコマンドの種類、実行ファイルのパス名を確認できる。  

# ユーザーとグループの管理(第11章)  

## ユーザー設定関連  
UNIXでユーザーとなるためには、対象のユーザーを登録する必要がある。  
rootユーザーが以下のコマンドを使用して、ユーザー登録を行う。  
```
adduser ユーザー名
useradd ユーザー名  
```
一度登録したユーザー情報は/etc/psswdファイルに記載される。  
ユーザー設定を変更する場合、passwdファイルを直接編集するか、usermodコマンドを使用して変更する。  
```
usermod ユーザー名　ユーザー情報を変更する
```
usermodコマンドに関しても使用には管理者権限が必要になる。  

パスワードの設定・変更にはpasswdコマンドを使用する。  
スーパーユーザーはすべてのユーザーのパスワードを、一般ユーザーは自分のパスワードを変更できる。  
```
passwd 自分のパスワードの変更
passwd ユーザー名　指定したユーザーのパスワードを設定する
```
登録したユーザーが不要になった場合は削除を行う。  
ユーザーの削除にはuserdelコマンドを使用する。  
```
userdel ユーザー名　ユーザー登録を削除する
userdel -r ユーザー名　ユーザーのホームディレクトリも含めて削除する  
```

## グループ関連  
新しいグループの追加にはgroupaddコマンドを使用する。  
スーパーユーザーのみが実行可能。  
コマンド実行後、/etc/groupファイルにグループ情報が追加される。  
グループが不要になった場合は、groupdelコマンドを使用し削除が可能。  
現在使用しているユーザーがどのグループに所属しているかはgroupsコマンドで確認が可能。  
/etc/groupファイルへのグループメンバ追加は直接の編集以外でも行うことができる。  
ファイルは特定のグループに対してアクセスを許すかどうかを設定することができる。  
アクセスを許すグループを設定するときはchgrpコマンドを使用する。  
スーパーユーザー、属しているファイルのオーナーが実行可能。
```
chgrp グループ名　ファイル名 ファイルのグループ属性を変更
chgrp グループ名　ディレクトリ名　ディレクトリのグループ属性を変更  
```
ユーザーがUNIXにログインして作業をするとき、必ず◯◯グループの◯◯ユーザーとして活動している。  
対象のユーザーが複数グループに所属していたとしても、ある瞬間に活動している実グループ(カレントグループ)はひとつだけである。  
```
newgrp グループ名 実グループを変更する
newgrp 実グループをデフォルトに戻す
```

# ユーザーとグループの操作(第12章)  

## ユーザー変更  
あるユーザーでログインした後に別のユーザーでログインする場合、一旦ログアウトした上で再度ログインする必要がある。  
suコマンドを使用することで一時的に別のユーザーになることができる。  
「-」オプションを使用することで実行内容が異なる。  
|  記号  |  説明  |
| ---- | ---- |
|  - あり  |  新規でログインしたのと同じ状態になる  |
|  - なし |  現在のユーザーの状態が引き継がれる(カレントディレクトリが変わらない)  |  
suコマンドで新しいユーザーに移る場合、パスワードを入力する必要がある。  
スーパーユーザーから一般ユーザーに移る場合はパスワードは不要。  
元のユーザーに戻る場合、exitコマンドを使用する。  
いったん別のユーザーになるのではなく、直接別ユーザーの権限のコマンドを実行する場合、sudoコマンドを実行する。  
sudo方式では使用するパスワードは自分のパスワードになるのでrootのパスワードを知らせる必要がない。  
ユーザーごとにsudoで実行可能なコマンドを限定できるため、特権ユーザーが増えてしまうこともない。  
sudoで実行可能なユーザーとコマンドは/etc/sudoersファイルで管理されている。  
sudoersファイルの詳細な設定方法は「man sudoers」を参照する。  

## ユーザー情報の確認  
ログインしたユーザー、現在のディレクトリ名が分からなくなった場合ユーザー情報を確認する必要がある。  
作業ディレクトリの確認はpwdコマンド、ユーザー名・グループ名の確認はwhoamiコマンドを使用する。  
idコマンドを使用することでユーザーID、グループIDを確認することができる。  
UNIXでは登録されたユーザーの情報は/etc/passwdファイルに記載されている。  
ユーザー情報の記録は1ユーザー1行で以下のように記載される。  
```
ユーザー名：パスワード：ユーザーID：グループID：ユーザー情報：ホームディレクトリ：ログインシェル
```
スーパーユーザーがpasswdファイルを修正中に一般ユーザーがその内容を変更することを避けるため、passwdファイルの編集にvipwコマンドを使用する。  
vipwコマンドにより、編集の間/etc/passwdに対してロックをかけることができ、他のユーザーが編集を行うことができないようにすることができる。  
パスワードファイルの編集にはvipwコマンドを使用する。  
passwdファイルの内容のうち、ユーザー情報は、ユーザーが自分に関する情報を自由に記載することができる。  
/etc/passwdファイルは不特定の人が閲覧することができるため、プライバシーに関わる情報は一般的には記載しない。  

## ユーザー情報の設定  
ユーザー情報の編集はvipwコマンドによる編集だけでなく、chfnコマンドを使用して行うことも可能。  
chfnコマンドを使用した場合、一般ユーザーも自分の情報を変更することができる。  
```
chfn ◯◯　スーパーユーザーが◯◯ユーザーの情報を変更する
chfn 一般ユーザーが自分の情報を変更する
```
passwdファイルの内容は一般ユーザーでも閲覧することができる。  
設定されているパスワードも読むことができ、パスワードも見ることができてしまうため一般的に「シャドウパスワード方式」を利用する。  
シャドウパスワード方式ではスーパーユーザーしか見ることのできない/etc/shadowに暗号化したパスワードを記載する。  

ログイン状態のユーザーを調べる場合、以下のコマンドを使用する。  
```
who ログインユーザー情報を表示
who am i 自分のユーザー情報のみを表示
```

# ファイルシステムとマウント処理(第13章)  

## ディレクトリ構成  
階層構造の頂点をルートディレクトリと呼び、ディレクトリにはそれぞれ名前をつける。  
ルートディレクトリには特別に"/"記号をつけ識別する。  
UNIXでは基本的なディレクトリは標準の名前で構成される。  
ディレクトリ名をみると、そこに格納されているファイルの性格を確認することができる。  
UNIXでは/usrは特別なディレクトリであり、重要なサブディレクトリが置かれている。  
複数のファイルを置くため、大きなファイル領域を必要とする。  
UNIXコマンドは以下のように分納されている。  
```
/bin UNIX基本コマンドを格納
/usr/bin UNIX一般コマンドを格納
```
/usrディレクトリがマウントできないトラブルが発生した場合でも、最小構成の/binにあるUNIXコマンドだけは有効にすることができる。  
```
マウント：記憶装置をファイルシステムにつなぎこむ
アンマウント：記憶装置をファイルシステムから切り離す
```
マウントをすることでDVDメモリ等もUNIXファイルシステムの中のひとつのディレクトリとして処理できるようになる。  
Linuxでハードディスクを使用するためには、Linuxで読み書き可能なファイルシステムにフォーマットする必要がある。  

## コマンドを使用したマウント  
マウントの基本用法としてファイルシステムのタイプ名を指定する。  
コマンドはrootユーザーで実行する。  
```
mount デバイス名　マウントポイント名
mount デバイス名またはマウントポイント名
```
アンマウントはunmountコマンドを使用して実行する。  

マウント操作を簡略化するために、ファイルシステムタイプや接続先の情報を/etc/fstabファイルに登録することが可能。  
最初にfstabファイルに情報がある場合、それを収集する。  
情報がない場合mountコマンドで指定された情報を反映する。  

## オープン中のファイル  
一般ユーザーがディスク上のファイルを使用している場合、スーパーユーザーを含む全てのユーザーでディスクのアンマウントをすることができない。  
ユーザーが使用中のファイル情報をlsofコマンドを使用して調べることができる。  
```
lsof オープン中のファイル情報の表示
```
把握していない部分で開かれているファイルが大量になることがあるため、lsofコマンドの使用の際はgrepコマンドと組みわせることが一般的。  

# シェル操作(第14章)  

## カーネルとシェル  
OSの中心となる機能を実現するプログラムをカーネルと呼ぶ。  
カーネルはメモリ、周辺装置、ファイルシステムを管理し、指定されたコマンドを実行する。  
カーネル機能を直接ユーザーが操作することは不便なため、カーネルとユーザーの橋渡しをするプログラムであるシェルを使用する。  
シェルはユーザーの入力を解釈し、指示されたコマンドを実行する。  
シェルは、  
- リダイレクト  
- パイプ  
- コマンド連続実行  
- バッチ処理
などで使われる。  
ユーザーはログインする際にどのシェルを使うかを指定することができる。  
カーネルは指定されたシェルを起動する。  
シェルはプログラミングにも使用され、シェルプログラムを記述したテキストファイルをスクリプトと呼ぶ。  

## 主なシェルの種類  
 
|  シェル  |  説明  |
| ---- | ---- |
|  sh  |  シェルスクリプト用に使われることが一般的  |
|  bash  |  shとの互換性がある。Linux標準のシェル  |
|  csh |  C言語に類似したプログラミング機能を持つシェル  |
|  tcsh  |  cshに機能追加をしたシェル。コマンド補完機能、スペル訂正機能を追加。  |

## シェルの環境設定  
ユーザーがログインすると「/etc/passwd」ファイルの中にユーザーによって記述されたログインシェルが起動する。  
その起動したシェルのルールに従って環境設定が行われる。  
ログインシェルではなく一時的に使用するシェルとして起動させたちき(ユーザーがコマンドラインでbashを入力しシェルを実行したとき)、＾/.bashrcの設定ファイルが実行される。  
環境設定について2つのパターンが存在する。  
- ログインシェルを使用した場合、ログイン関連ファイルと＾/.bashrcが実行される  
- 一時起動シェルを使用した場合、＾/.bashrcのみが実行される  

## シェル変数  
シェルにはある値を保持するシェル変数という機能が存在する。  
シェルの動き方の確認や、シェルスクリプト内のプログラミングに使用される。  
setコマンドを使用しすべての変数の設定内容を見ることができる。  
シェル変数を設定・参照する場合、代入式を使用する。  
```
myvar=abc 変数myvarを定義しその値にabcを設定  
echo $myvar 変数myvarの値を表示  
```
setコマンドを実行するとユーザーが設定した設定値以外に最初から用意されている組み込み変数が存在する。  
|  変数名  |  説明  |
| ---- | ---- |
|  PATH  |  コマンドを検索するディレクトリのリスト  |
|  HOME  |  ユーザーのホームディレクトリ  |
|  PS1 |  プロンプトを設定する  |
|  PS2  |  行継続をしたときのプロンプトを決める  |

## 検索パスの設定  
PATH変数にはUNIXがコマンドを検索するディレクトリリストを設定する。  
PATHには複数のディレクトリを設定できる。  
UNIXではカレントディレクトリであっても環境変数PATHで設定されていないディレクトリは検索しない。  
ホームディレレクトリであっても必要に応じて環境変数PATHに設定する必要がある。  

## 環境変数の設定  
シェル変数は現在有効になっているシェルの中でのみ通用する。  
シェルの中から新しいプログラムを起動したとき、シェル変数が新しいプログラムに引き継がれることはない。  
変数の内容を引き継がせたい場合、シェル変数を環境変数に変更する必要がある。  
シェル変数から環境変数への昇格にはexportコマンドを使用する。  
```
方法1  
myvar=abc
export myvar シェル変数を定義して環境変数にする  
方法2  
export mybar=abc はじめから環境変数として定義する  
```
setコマンドで表示されるシェル変数リストの中には、環境変数も含まれている。  
環境変数が含まれているものの、どれが環境変数であるかを判断することはできないため、環境変数だけを表示する場合はprintenvコマンドを使用する。  

## シェルの組み込みコマンド  
UNIXのコマンドの多くはコマンド対応の実行可能ファイルが用意されている。  
簡単なコマンドの場合はシェル内部に組み込まれているものもあり、その場合はパスが通っていなくても実行することができる。  
どれが組み込みコマンドであるかはhelpコマンドを使って調べることができる。  


